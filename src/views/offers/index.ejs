<!DOCTYPE html>
<html lang="en">
<head>
    <%- include("./partials/head") %>
    <link rel="stylesheet" href="/css/offers.css">
    <title><%= title  %></title>
</head>
<body>
    <%- include("./partials/nav") %>
    <% const sontuyas =  title == "Ofertas Enviadas" ? true : false %>
    <div class="container-offers">
        <div class="title-filter-order">
            <h1 class="title-page">Estas viendo <%= sontuyas ? `tus ${title}` : `las ${title}` %> </h1>
            <p>tenes <%= ofertas.length %> ofertas</p>

            <div class="filter-order">

                <select id="select-order" onchange="orden('select-order')" >
                    <option value="orderByASC" <% (order === "orderByASC") ? "selected" : null %>>Ascendente</option>
                    <option value="orderByDESC" <%= order === "orderByDESC" ? "selected" : null %>>Descendente</option>
                </select>

                <select id="select-filter" onchange="filtro('select-filter')">
                    <option value="" <% (filter === undefined) ? "selected" : null %>>Todas</option>
                    <option value="filterByPendientes" <%= filter == "filterByPendientes" ? "selected" : null %>>Pendientes</option>
                    <option value="filterByRechazadas" <%= filter == "filterByRechazadas" ? "selected" : null %>>Rechazadas</option>
                    <option value="filterByAceptadas" <%= filter == "filterByAceptadas" ? "selected" : null %>>Aceptadas</option>
                </select>

            </div>

        </div>


        <% if (ofertas.length > 0) { %>

            <main class="offers">
                <% ofertas.forEach(oferta => { %>

                    <div class="card-offer">
                        
                        <div class="offer-images">
    
                            <div class="images-names">
                                <a class="container-post" href="/posts/<%= oferta.publicacion_id  %>">
                                    <img class="images" src="/publicaciones/<%=oferta.Publicacion.url_foto %>" alt="">
                                    <p class="name-post"><%=sontuyas ? "Publicacion Del Usuario" : "Mi Publicacion" %></p>
                                </a>
                            </div>
                            
                            <div class="flecha-intercambio">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            </div>

                            <div class="images-names">
                                <img class="images" src="/ofertas/<%=oferta.url_foto %>" alt="">
                                <p class="name-post"><%=sontuyas ? "Mi Oferta" : "Oferta Del Usuario" %></p>
                            </div>

                        </div>
    
                        <div class="offers-info">
                            <%- !sontuyas ?  `<p class="ofertante"><strong>Ofertante:</strong> ${oferta.Usuario.nombre}</p>` : null %>
                            <p class="filial"><strong>Filial:</strong> <%=oferta.Filial.nombre %> (<%=oferta.Filial.direccion %>)</p>
                            <p class="fecha"><strong>Fecha:</strong> <%=oferta.fecha.split("-").reverse().join("-") %></p>
                            <p class="hora"><strong>Horario:</strong> <%=oferta.hora.slice(0,-3) %></p>
                            <button id="<%= `btn-${oferta.id}` %>" style=" width: 149.44px; padding: 10px; background-color: #abb444; border: none; color: white; cursor: pointer;" <%- `onclick="showModal('${oferta.nombre}', '${oferta.Categoria.nombre}', '${oferta.descripcion}' )"` %> >Info Oferta</button>
                        </div>

                        <div class="offers-states">
                            <% if ( !sontuyas && oferta.estado == "pendiente") { %>
                                <div class="buttons">
                                    <form class="" action="/offerAccept/<%=oferta.id %>" method="post"> <button class="btn-form aceptar" type="submit">Aceptar</button></form>
                                    <form  action="/offerReject/<%=oferta.id %>" method="post"> <button class="btn-form rechazar" type="submit">Rechazar</button></form>
                                    <a class="btn contraOferta" href="">Contraofertar</a>
                                </div>
    
                            <% } else {%>
                                <div class="state">
                                    <p class="estado">Oferta <%=oferta.estado %></p>
                                </div>
                            <% } %>

                        </div>
        
                        
                    </div>
        
                <% }) %>
            </main>
    


        <% } else { %>
            <p class="vacio">Todavia no tenes ofertas <%= (filter === undefined) ? null : "en este estado" %> </p>
        <% } %>
        

    </div>


    <%- include("./partials/footer") %>
</body>
<script src="/js/checkroute.js"></script>
<script>


const orden = id => {
    const select =  document.getElementById('select-order');
    const urlArray = window.location.pathname.split("/");
    const valorSeleccionado = select.options[select.selectedIndex].value;
    if (urlArray.length <= 4)  window.location.href = "/" + urlArray[1] + "/" + urlArray[2] + "/" + valorSeleccionado;
    else window.location.href = "/" + urlArray[1] + "/" +urlArray[2] + "/" + valorSeleccionado + "/" + urlArray[4];
}

const filtro = id => {
    const select =  document.getElementById('select-filter');
    const urlArray = window.location.pathname.split("/");
    const valorSeleccionado = select.options[select.selectedIndex].value
    if ( valorSeleccionado === "")  window.location.href = "/"+ urlArray[1] +"/" +urlArray[2] + "/" + urlArray[3];
    else window.location.href = "/"+ urlArray[1]  +"/" +urlArray[2] + "/" + urlArray[3] + "/" + valorSeleccionado;
}

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

const showModal = (name, category, desc) => {
    Swal.fire({
    title: `<p style="font-family:tahoma,verdana; margin-bottom: 5px">Estas viendo la oferta: ${name}</p>`,
    position: 'center',
    html: `
    <div style="font-family:verdana;">
        <p><strong>Categoria:</strong> ${category}</p>
        <p><strong>Descripcion:</strong> ${desc}</p>
    </div>
  `,
    showConfirmButton: false,
    showCloseButton: true,

    })
}


</script>
</html>